#!/bin/bash
#
#    orange-box-sync-charmstore
#    Copyright (C) 2014 Canonical Ltd.
#
#    Authors: Darryl Weaver <darryl.weaver@canonical.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.


# Only run this as root
if [ $EUID -ne 0 ]
then
	echo Execute as root or with \"sudo $0\"
	exit 1
fi

echo Creating Charm Store directories ...
[ -e /srv/charmstore/ ] || mkdir -p /srv/charmstore/
cd /srv/charmstore/
echo Grabbing the latest charmstore tarball...
[[ -f "latest.tar.gz" ]] && rm -f latest.tar.gz
wget -q http://people.canonical.com/~marco/mirror/juju/charmstore/latest.tar.gz
[[ -f "latest.tar.gz" ]] || exit
mkdir -p staging
cd staging
echo Untarring charmstore
tar xzf ../latest.tar.gz || exit
chown -R root.root *
for series in precise trusty
do
        cd $series
        bzr branch lp:~landscape/landscape-charm/stable landscape
        ln -s quantum-gateway neutron-gateway
        ln -s rabbitmq-server rabbitmq
        cd ..
done
cd ..
echo Removing the old directories...
rm -rf current
rm -rf snapshot-*
rm -rf precise
rm -rf trusty
echo Moving new charmstore into place
mv staging/* ./
rm -rf staging
rm -f latest.tar.gz
echo Done. && echo
echo "Charm store synced to directory /srv/charmstore/"
