#!/bin/sh
#
#    orange-box-sync-charmstore
#    Copyright (C) 2014 Canonical Ltd.
#
#    Authors: Darryl Weaver <darryl.weaver@canonical.com>
#             Dustin Kirkland <kirkland@canonical.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

BASEDIR=/srv/charmstore

set -x
set -e

if [ "$(id -u)" != "0" ]; then
        echo "Must be run with sudo or by root"
        exit 1
fi

bzr launchpad-login && rm -rf ~/.bazaar && bzr launchpad-login && echo "Unkown error with bzr launchpad-login" && exit 1

mkdir -p $BASEDIR
cd $BASEDIR
echo Grabbing the latest charmstore tarball...
rm -f "$BASEDIR/latest.tar.gz"
wget -q http://people.canonical.com/~marco/mirror/juju/charmstore/latest.tar.gz -O "$BASEDIR/latest.tar.gz" || exit 1
mkdir -p "$BASEDIR/staging"
echo Untarring charmstore
tar xzf "$BASEDIR/latest.tar.gz" -C "$BASEDIR/staging"
for series in precise trusty; do
	d="$BASEDIR/staging/$series"
	if [ ! -e $d/landscape ];then
		bzr branch lp:landscape-charm "$d/landscape"
	fi
	if [ ! -e $d/cinder-ceph ]; then
		bzr branch lp:charms/cinder-ceph "$d/cinder-ceph"
	fi
	if [ ! -e $d/neutron-gateway ]; then
		ln -s quantum-gateway "$d/neutron-gateway"
	fi
	if [ ! -e $d/rabbitmq ]; then
		ln -s rabbitmq-server "$d/rabbitmq"
	fi
	#Check for some charms that are pre-requisites for demos to run.
	if [ ! -e $d/juju-gui ]; then
                echo "Cannot find juju-gui in charm store update, it is required, exiting."
		exit 1
        fi
	if [ ! -e $d/mysql ]; then
                echo "Cannot find mysql in charm store update, it is required, exiting."
                exit 1
        fi
        if [ ! -e $d/rabbitmq-server ]; then
                echo "Cannot find rabbitmq-server in charm store update, it is required, exiting."
                exit 1
        fi
done

chown -R root.root $BASEDIR
echo "Removing the old directories..."
rm -rf "$BASEDIR/current" "$BASEDIR/snapshot-"* "$BASEDIR/precise" "$BASEDIR/trusty"
echo "Moving new charmstore into place"
mv -f "$BASEDIR/staging/"* "$BASEDIR/"
rm -rf "$BASEDIR/staging" "$BASEDIR/latest.tar.gz"
echo "Done"
echo
echo "Charm store synced to directory /srv/charmstore/"
