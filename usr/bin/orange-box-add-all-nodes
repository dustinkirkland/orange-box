#!/bin/bash
#
#    orange-box-amttool-helper - add all local nodes in the micro-cluster
#    Copyright (C) 2014 Canonical Ltd.
#
#    Authors: Dustin Kirkland <kirkland@canonical.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

. /usr/lib/orange-box/inc/common
. /etc/maas/maas_cluster.conf

set -e
set -x

list_all_nodes() {
	maas admin nodes list | grep system_id | sed -e 's/\",//' -e 's/.*\"//' | sort -u
}

oauth_login

export AMT_PASSWORD="Password1+"
# VNC Password MUST BE *exactly 8 characters long and contain 1 capital letter, a number, and a special character!!!
export VNC_PASSWORD="Ubuntu1+"
nodelist=/usr/share/orange-box/nodelists/$(hostname)

# First, delete any and all nodes
for system_id in $(list_all_nodes); do
	maas admin node delete $system_id
done

# Loop over our database of known mac addresses
for mac in $(grep -v "^#" $nodelist | awk '{print $1}'); do
	hostname=$(grep "^$mac" $nodelist | awk '{print $2}')
	ip=$(arp -na | grep $mac | sed -e 's/.*(//' -e 's/).*//')
	if [ -z "$ip" ] || [ "$ip" = "10.14.4.1" ]; then
		continue
	fi
	echo "$ip $mac"
	# Sorry for the name
	wake_me_up_before_you_go_go $ip

	# Enable remote VNC to each node
	# set the vnc password
	wsman put http://intel.com/wbem/wscim/1/ips-schema/1/IPS_KVMRedirectionSettingData -h $ip -P 16992 -u admin -p ${AMT_PASSWORD} -k RFBPassword=${VNC_PASSWORD} > /dev/null 2>&1
	# enable KVM redirection to port 5900
	wsman put http://intel.com/wbem/wscim/1/ips-schema/1/IPS_KVMRedirectionSettingData -h $ip -P 16992 -u admin -p ${AMT_PASSWORD} -k Is5900PortEnabled=true > /dev/null 2>&1
	# disable opt-in policy
	wsman put http://intel.com/wbem/wscim/1/ips-schema/1/IPS_KVMRedirectionSettingData -h $ip -P 16992 -u admin -p ${AMT_PASSWORD} -k OptInPolicy=false > /dev/null 2>&1
	# disable session timeout
	wsman put http://intel.com/wbem/wscim/1/ips-schema/1/IPS_KVMRedirectionSettingData -h $ip -P 16992 -u admin -p ${AMT_PASSWORD} -k SessionTimeout=0 > /dev/null 2>&1
	# enable KVM
	wsman invoke -a RequestStateChange http://schemas.dmtf.org/wbem/wscim/1/cim-schema/2/CIM_KVMRedirectionSAP -h ${ip} -P 16992 -u admin -p ${AMT_PASSWORD} -k RequestedState=2 > /dev/null 2>&1
	# Add the node to MAAS
	run-one-until-success maas admin nodes new nodegroup=$CLUSTER_UUID architecture=amd64 power_type=amt mac_addresses=$mac power_parameters_mac_address=$mac power_parameters_power_pass=$AMT_PASSWORD hostname=$hostname
	wake_me_up_before_you_go_go $ip
	(yes | amttool $ip powerdown >/dev/null 2>&1) || true
	sleep 1
	wake_me_up_before_you_go_go $ip
	yes | run-one-until-success amttool $ip powerup pxe
done

# Cool, everything is added, lets make them fastpath
for system_id in $(list_all_nodes); do
	maas admin tag update-nodes use-fastpath-installer add=$system_id
done
