#!/bin/bash

if [ "$(id -u)" != "0" ]; then
  echo "Must be run with sudo or by root"
  exit 77
fi

set -e

. inc/common

# Configure NAT and IP forwarding, giving slave NUCs external network access
# through the master.

# Note that this script assumes no existing iptables rules. If you do have
# any, they will be deleted.

# Enable IP forwarding and save for next boot
echo 1 > /proc/sys/net/ipv4/ip_forward
echo "net.ipv4.ip_forward=1" > /etc/sysctl.d/10-maas-ip-forward
sysctl --system

# Some things use the MAAS proxy - some things don't. So turn on NAT.
# First we blow away the existing postrouting/NAT config.

if ! config_get "iface"; then
  iface=`detect_inet`
  # Save the value so we don't have to look it up each time
  config_set iface="$iface"
else
  iface=`config_get "iface"`
fi


echo "Clean current iptable rules"
iptables -F
iptables -t nat -F
iptables -t mangle -F

echo "Setting up ip forwarding"
iptables -t nat -A POSTROUTING -o $iface -j MASQUERADE
iptables -A FORWARD -i $iface -o em1 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i em1 -o $iface -j ACCEPT

# Ubuntu for some reason does not install requirements for iptables
# to be persisted across reboots. So let's fix that.

apt-get update
apt-get install iptables-persistent

iptables-save > /etc/iptables/rules.v4

dnsserver=""

if config_key_exists "dnsserver"; then
  dnsserver=`config_get "dnsserver"`
else
  # Sane default?
  dnsserver="8.8.8.8"
fi

echo "In order for DNS resolution to work, we need to know where we should"
echo "forward DNS requests. Please enter the value below. To disable, enter"
echo "a blank line"
echo -n "DNS Server [$dnsserver]: "
# Read probably isn't good but with no argparse, ligaf
read -e -p "DNS Server:" -i "$dnsserver" dnsserver

# Subsequent runs of this script will produce the DNS server as default
config_set "dnsserver" "$dnsserver"

if [ "$dnsserver" != "" ]; then
	cat > /etc/bind/named.conf.options << EOF
options {
	directory "/var/cache/bind";
	forwarders {
		$dnsserver;
	};
	dnssec-validation auto;
	auth-nxdomain no;    # conform to RFC1035
	listen-on-v6 { any; };
};
EOF
	service bind9 restart
fi

# This is probably bad, need to learn more about resolvconf, LIGAF
cat > /etc/resolvconf/resolv.conf.d/head << EOF
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 10.0.0.1
search master
EOF

resolvconf -u
